<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="A deep dive into how eBPF compares to traditional LKM rootkits, including hands-on demos using BCC, bpftrace, and libbpf." />
<meta name="keywords" content="mathscantor, ebpf, linux, malware" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="dark" />
<link rel="canonical" href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/" />


    <title>
        
            eBPF Malware Techniques Part 1 - Introduction :: Mathscantor&#39;s Cybersecurity Blog  — A simple theme for Hugo
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.f6f782c824f6dd87699befc194c23b539768dd232f320940bfeb2e17f8317145.css">





    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">



  <meta itemprop="name" content="eBPF Malware Techniques Part 1 - Introduction">
  <meta itemprop="description" content="A deep dive into how eBPF compares to traditional LKM rootkits, including hands-on demos using BCC, bpftrace, and libbpf.">
  <meta itemprop="datePublished" content="2025-04-05T09:20:03+08:00">
  <meta itemprop="dateModified" content="2025-04-05T09:20:03+08:00">
  <meta itemprop="wordCount" content="2223">
  <meta itemprop="image" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/images/cover.png">
  <meta itemprop="keywords" content="Ebpf,Linux,Malware">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/images/cover.png">
  <meta name="twitter:title" content="eBPF Malware Techniques Part 1 - Introduction">
  <meta name="twitter:description" content="A deep dive into how eBPF compares to traditional LKM rootkits, including hands-on demos using BCC, bpftrace, and libbpf.">



    <meta property="og:url" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/">
  <meta property="og:site_name" content="Mathscantor&#39;s Cybersecurity Blog">
  <meta property="og:title" content="eBPF Malware Techniques Part 1 - Introduction">
  <meta property="og:description" content="A deep dive into how eBPF compares to traditional LKM rootkits, including hands-on demos using BCC, bpftrace, and libbpf.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-05T09:20:03+08:00">
    <meta property="article:modified_time" content="2025-04-05T09:20:03+08:00">
    <meta property="article:tag" content="Ebpf">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Malware">
    <meta property="og:image" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/images/cover.png">
      <meta property="og:see_also" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-4-hiding-processes/">
      <meta property="og:see_also" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-3-hiding-bpf-traces/">
      <meta property="og:see_also" content="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-2-setting-appropriate-hooks/">






    <meta property="article:published_time" content="2025-04-05 09:20:03 &#43;0800 &#43;08" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span data-pagefind-ignore class="logo__text">Be You Cat, or Mouse?</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner">
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/posts/">
                        Posts
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/tags/">
                        Tags
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/series/">
                        Series
                    </a>
                </li>
            </div>
            
        
            
            <div class="submenu">
                <li class="dropdown">
                    <a href="/about">
                        About
                    </a>
                </li>
            </div>
            
        

    
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
                <span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
   <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
   3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
   13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
 </svg></span>
        </span>
    </span>
</header>


            <div class="content">
                

  <main class="post">
    
    <link href="/posts/css/toc.css" rel="stylesheet">
    <aside id="sticky-toc">
      <div class="toc-title">Table of Contents</div>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#1-background">1. Background</a></li>
    <li><a href="#2-portability-why-ebpf-wins-over-lkms">2. Portability: Why eBPF Wins Over LKMs</a></li>
    <li><a href="#3-limitations-of-ebpf">3. Limitations of eBPF</a></li>
    <li><a href="#4-frameworks">4. Frameworks</a>
      <ul>
        <li><a href="#41-bcc-bpf-compiler-collection">4.1 BCC (BPF Compiler Collection)</a></li>
        <li><a href="#42-bptrace">4.2 bptrace</a></li>
        <li><a href="#43-libbpf">4.3 libbpf</a></li>
      </ul>
    </li>
    <li><a href="#5-conclusion">5. Conclusion</a></li>
  </ul>
</nav>
    </aside>
    <script src="/posts/js/toc.js"></script>
    
    <article>
      
      <div class="post-thumbnail">
          <img src="/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/images/cover.png" alt="post image" style="display: block; margin-left: auto; margin-right: auto; max-width: 50%; max-height: 50%; margin-bottom: 1em;">
      </div>
      
      <h1 class="post-title">
        <a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/">eBPF Malware Techniques Part 1 - Introduction</a>
      </h1>
      <div class="post-info">
        <p>
          <i class="fa-solid fa-clock"></i>
          11 Minutes
          <i class="fa-solid fa-clipboard"></i>
          2223 Words
          
        </p>
        <p>
          <i class="fa-solid fa-calendar-days"></i>
          
            2025-04-05 09:20
          
  
           
            
          
        </p>
        <p>
        <p>
          <i class="fa-solid fa-eye"></i>
          <span id="stats"></span>
<script>
(function() {
  var r = new XMLHttpRequest();
  r.addEventListener('load', function() {
    var statsEl = document.getElementById("stats");
    if (!statsEl) return;

    try {
      var count = JSON.parse(this.responseText).count_unique;
      console.log(count);
      statsEl.innerText = count == 1
        ? "1 View"
        : count + " Views";
    } catch (e) {
      console.error("GoatCounter stats error:", e);
    }
  });

  r.open('GET', 'https://mathscantor.goatcounter.com/counter/' +
    encodeURIComponent(location.pathname.replace(/(\/)?$/, '')) + '.json');
  r.send();
})();
</script>

        </p>
        
    <p>
        <i class="fa-solid fa-tag"></i>
        

        <span class="tag"><a href="https://mathscantor.github.io/tags/ebpf/">ebpf</a></span>
        <span class="tag"><a href="https://mathscantor.github.io/tags/linux/">linux</a></span>
        <span class="tag"><a href="https://mathscantor.github.io/tags/malware/">malware</a></span>
        
    </p>

      </br>
        </p>
      </div>
      
        <div class="post-excerpt">A deep dive into how eBPF compares to traditional LKM rootkits, including hands-on demos using BCC, bpftrace, and libbpf.</div>
      

      

      

      <div class="post-content">
        <hr>
        
          <div class="post-series"><h3 id="series"> eBPF Malware Techniques Series:</h3> 
    <ol><li><b>eBPF Malware Techniques Part 1 - Introduction</b></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-2-setting-appropriate-hooks/">eBPF Malware Techniques Part 2 - Setting Appropriate Hooks</a></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-3-hiding-bpf-traces/">eBPF Malware Techniques Part 3 - Hiding BPF Traces</a></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-4-hiding-processes/">eBPF Malware Techniques Part 4 - Hiding Processes</a></li></ol></div>
          <hr>
        
        <h2 id="1-background">1. Background</h2>
<p>As a cybersecurity researcher, understanding both traditional and modern methods of kernel-level code execution is crucial. Two prominent techniques you&rsquo;ll encounter are LKM (Loadable Kernel Module) rootkits and eBPF-based applications.</p>
<p>eBPF (extended Berkeley Packet Filter) is a Linux kernel technology that allows safe, user-defined code to run in kernel context. Originally intended for packet filtering, eBPF has evolved into a generic in-kernel virtual machine — enabling dynamic tracing, monitoring, networking, and even security enforcement.</p>
<p>Unlike traditional rootkits that load kernel modules (LKMs), eBPF programs are loaded from user space and executed within a sandboxed, verified environment in the kernel.</p>
<h2 id="2-portability-why-ebpf-wins-over-lkms">2. Portability: Why eBPF Wins Over LKMs</h2>
<p>One of the biggest advantages of eBPF over LKM-based approaches is portability. Traditional rootkits written as LKMs often rely on specific internal kernel symbols and structures that vary between kernel versions, making them fragile and version-locked.</p>
<p>eBPF solves this through:</p>
<ul>
<li>
<p>CO-RE (Compile Once, Run Everywhere): With the help of BTF (BPF Type Format), an eBPF binary can automatically adapt to the target kernel&rsquo;s data structures at load time.</p>
</li>
<li>
<p>Stable Kernel Interfaces: eBPF relies on stable hooks like tracepoints, kprobes, and cgroups, avoiding the need to patch or hook private kernel symbols.</p>
</li>
<li>
<p>User-space Loaders: eBPF programs are loaded via syscalls (e.g., bpf()), removing the need for privileged LKM loading mechanisms like <code>insmod</code> or <code>modprobe</code>.</p>
</li>
</ul>
<h2 id="3-limitations-of-ebpf">3. Limitations of eBPF</h2>
<p>Despite its flexibility and growing popularity, eBPF is not a silver bullet for kernel-level control. It is tightly restricted by design:</p>
<ul>
<li>
<p>Instruction Limit: Modern Linux kernels (e.g., 5.8+) support a maximum of 1 million instructions per program, though earlier versions had a hard limit of just 4096. This constraint exists to prevent DoS conditions from long-running programs.</p>
</li>
<li>
<p>No Loops (until recently): Older kernels rejected any loops to avoid non-terminating programs. Newer kernels (5.3+) allow bounded loops — but they must pass static verification.</p>
</li>
<li>
<p>No Arbitrary Memory Access: You can’t just dereference random kernel pointers. All memory accesses must be checked or derived from known safe helpers.</p>
</li>
<li>
<p>Strict Verifier Checks: The eBPF verifier enforces constraints like:</p>
<ul>
<li>No null pointer dereferencing</li>
<li>Stack bounds checking</li>
<li>No uninitialized memory use</li>
<li>Guaranteed program termination</li>
</ul>
</li>
</ul>
<h2 id="4-frameworks">4. Frameworks</h2>
<p>When creating eBPF applications, there are 3 major frameworks to consider. Depending on your usage, you may prefer one over the other.
The table below summarizes the points to consider for eBPF development.</p>
<table>
  <thead>
      <tr>
          <th>Framework</th>
          <th>Language</th>
          <th>Kernel Requirement</th>
          <th>Package Needed</th>
          <th>Best For</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><em>BCC</em></td>
          <td>Python/C++</td>
          <td>≥ 4.1 (≥ 4.9 ideal)</td>
          <td><code>bcc</code>, <code>python3-bcc</code></td>
          <td>Quick development, scripting</td>
      </tr>
      <tr>
          <td><em>bpftrace</em></td>
          <td>Custom DSL</td>
          <td>≥ 4.9 (≥ 5.5 ideal)</td>
          <td><code>*bpftrace*</code></td>
          <td>One-liners, dynamic tracing</td>
      </tr>
      <tr>
          <td>libbpf</td>
          <td>C</td>
          <td>≥ 4.18 (BTF needed)</td>
          <td><code>libbpf-dev</code>, Clang, LLVM</td>
          <td>Performance, production systems</td>
      </tr>
  </tbody>
</table>
<link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="table">eBPF Frameworks<br><br></span>
<h3 id="41-bcc-bpf-compiler-collection">4.1 BCC (BPF Compiler Collection)</h3>
<p><a href="https://github.com/iovisor/BCC"><em>BCC</em></a> is a toolkit for creating efficient kernel tracing and manipulation programs, and includes several useful tools and examples. It makes use of eBPF, a new feature that was first added to Linux 3.15. Much of what <em>BCC</em> uses requires Linux 4.1 and above.</p>
<p><em>BCC</em> makes BPF programs easier to write, with kernel instrumentation in C (and includes a C wrapper around LLVM), and front-ends in Python and lua. It is suited for many tasks, including performance analysis and network traffic control.</p>
<p>To get started, we need to first get its dependencies.</p>
<p>In my case, I am using Ubuntu 24.04 and therefore, I will need the following packages:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># python3-pyelftools needed for following example</span>
</span></span><span style="display:flex;"><span>$ sudo apt install bpfcc-tools python3-bcc python3-pyelftools linux-headers-<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing"><em>BCC</em> Packages for Ubuntu<br><br></span>
However, if you are using another Linux distro, please refer to the official <a href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">installation guide</a>. Once this step is done, we can test out many of the provided <a href="https://github.com/iovisor/bcc/tree/master/tools">tools</a> written by <a href="https://github.com/iovisor">iovisor</a> and many of its contributors.</p>
<p>I am simply going to choose <a href="https://github.com/iovisor/bcc/tree/master/tools/bashreadline.py">bashreadline.py</a> as my example.</p>
<p>Looking at the code, it searches for the symbol <em>readline_internal_teardown()</em> in either <code>/bin/bash</code> or <code>/lib/libreadline.so</code>.
If the <code>--shared</code> option is not specified, then it defaults to /bin/bash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>parser <span style="color:#f92672">=</span> argparse<span style="color:#f92672">.</span>ArgumentParser(
</span></span><span style="display:flex;"><span>        description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Print entered bash commands from all running shells&#34;</span>,
</span></span><span style="display:flex;"><span>        formatter_class<span style="color:#f92672">=</span>argparse<span style="color:#f92672">.</span>RawDescriptionHelpFormatter)
</span></span><span style="display:flex;"><span>parser<span style="color:#f92672">.</span>add_argument(<span style="color:#e6db74">&#34;-s&#34;</span>, <span style="color:#e6db74">&#34;--shared&#34;</span>, nargs<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;?&#34;</span>,
</span></span><span style="display:flex;"><span>        const<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/lib/libreadline.so&#34;</span>, type<span style="color:#f92672">=</span>str,
</span></span><span style="display:flex;"><span>        help<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;specify the location of libreadline.so library.</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span><span style="color:#e6db74">              Default is /lib/libreadline.so&#34;</span>)
</span></span><span style="display:flex;"><span>args <span style="color:#f92672">=</span> parser<span style="color:#f92672">.</span>parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> args<span style="color:#f92672">.</span>shared <span style="color:#66d9ef">if</span> args<span style="color:#f92672">.</span>shared <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#34;/bin/bash&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing"><em>BCC</em> Packages for Ubuntu<br><br></span>
<p>It then defines the main logic of the eBPF program in C as defined by <em>bpf_text</em>. This will act as the main logic to our eBPF program. This code simply gets the PID that calls on <em>readline_internal_teardown()</em>. If the process that triggers this is &ldquo;bash&rdquo;, then it will send the context data from kernel space to user space via the <a href="https://docs.kernel.org/userspace-api/perf_ring_buffer.html">perf</a> ring buffer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;uapi/linux/ptrace.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/sched.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">str_t</span> {
</span></span><span style="display:flex;"><span>    u32 pid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> str[<span style="color:#ae81ff">80</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BPF_PERF_OUTPUT</span>(events);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">printret</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>ctx) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> <span style="color:#66d9ef">str_t</span> data  <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> comm[TASK_COMM_LEN] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">PT_REGS_RC</span>(ctx))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    data.pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">bpf_get_current_pid_tgid</span>() <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bpf_probe_read_user</span>(<span style="color:#f92672">&amp;</span>data.str, <span style="color:#66d9ef">sizeof</span>(data.str), (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#a6e22e">PT_REGS_RC</span>(ctx));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bpf_get_current_comm</span>(<span style="color:#f92672">&amp;</span>comm, <span style="color:#66d9ef">sizeof</span>(comm));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (comm[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;b&#39;</span> <span style="color:#f92672">&amp;&amp;</span> comm[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> comm[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;s&#39;</span> <span style="color:#f92672">&amp;&amp;</span> comm[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;h&#39;</span> <span style="color:#f92672">&amp;&amp;</span> comm[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> ) {
</span></span><span style="display:flex;"><span>        events.<span style="color:#a6e22e">perf_submit</span>(ctx,<span style="color:#f92672">&amp;</span>data,<span style="color:#66d9ef">sizeof</span>(data));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Definition of <em>bpf_text</em><br><br></span>
<p>Lastly, it uses <em>uretprobe</em> to hook onto the return of <em>readline_internal_teardown()</em> function. It also points the logic of our eBPF program to the <em>printret()</em> function defined in <em>bpf_text</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> BPF(text<span style="color:#f92672">=</span>bpf_text)
</span></span><span style="display:flex;"><span>b<span style="color:#f92672">.</span>attach_uretprobe(name<span style="color:#f92672">=</span>name, sym<span style="color:#f92672">=</span>sym, fn_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;printret&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Attaching to <em>printret()</em> with <em>uretprobe</em><br><br></span>
<p>Alright, enough babbling. Let&rsquo;s see this in action.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo python3 bashreadline.py
</span></span></code></pre></div><video width=100% controls>
    <source src="/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/videos/bcc-bashreadline.webm" type="video/webm">
    Your browser does not support the video tag.  
</video>
<link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="video"><em>BCC</em> Demo - bashreadline.py<br><br></span>
<h3 id="42-bptrace">4.2 bptrace</h3>
<p><em>bpftrace</em> is a high-level tracing language for Linux. <em>bpftrace</em> uses LLVM as a backend to compile scripts to <a href="https://ebpf.io/what-is-ebpf/">eBPF</a>-bytecode and makes use of <a href="https://github.com/libbpf/libbpf">libbpf</a> and <a href="https://github.com/iovisor/bcc"><em>BCC</em></a> for interacting with the Linux BPF subsystem, as well as existing Linux tracing capabilities: kernel dynamic tracing (kprobes), user-level dynamic tracing (uprobes), tracepoints, etc. The <em>bpftrace</em> language is inspired by awk, C, and predecessor tracers such as DTrace and SystemTap. <em>bpftrace</em> was created by <a href="https://github.com/ajor">Alastair Robertson</a>.</p>
<p>There are several ways to install <em>bpftrace</em>. Depending on your Linux distro, you may want to refer to the <a href="https://github.com/*bpftrace*/*bpftrace*/blob/master/INSTALL.md">installation guide</a>.</p>
<p>In my case, I will install <em>bpftrace</em> with <em>apt</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo apt-get install bpftrace
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Installing <em>bpftrace</em> on Ubuntu<br><br></span>
<p>Alternatively, you may also get a statically compiled <em>bpftrace</em> via the <a href="https://github.com/bpftrace/bpftrace/releases/latest/download/*bpftrace*">latest release</a>.</p>
<p>To use this tool properly, we can either supply it with a one-liner program or a file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># One-Liner Usage</span>
</span></span><span style="display:flex;"><span>$ bpftrace <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span> -e <span style="color:#e6db74">&#39;program&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example</span>
</span></span><span style="display:flex;"><span>$ bpftrace -e <span style="color:#e6db74">&#39;tracepoint:syscalls:sys_enter_openat { printf(&#34;%s %s\n&#34;, comm, str(args-&gt;filename)); }&#39;</span>
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing"><em>bpftrace</em> One-Liner Usage<br><br></span>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># File Usage</span>
</span></span><span style="display:flex;"><span>$ bpftrace <span style="color:#f92672">[</span>options<span style="color:#f92672">]</span> filename.bt
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Example</span>
</span></span><span style="display:flex;"><span>$ bpftrace bashreadline.bt
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing"><em>bpftrace</em> File Usage<br><br></span>
<p>Relating back to the previous example where we used <em>BCC</em> to read the user&rsquo;s bash terminal inputs, we can also do so with <em>bpfrace</em>!
Using the <a href="https://github.com/bpftrace/bpftrace/blob/master/tools/bashreadline.bt">bashreadline.bt</a> example provided by the bpftrace repository, we can achieve the same results as before.</p>
<p>However, let&rsquo;s take a look at what the code is doing first.
<link href="/posts/css/alert.css" rel="stylesheet">
<div class="alert note">
    <div class="alert-content">
        <div class="alert-header">
            <span class="alert-icon"></span>
            <strong class="alert-title">Note</strong>
        </div>
        <div class="alert-body"><ul>
<li>After this <a href="https://github.com/iovisor/bpftrace/pull/1971">pull request</a>, bpftrace now supports automatic resolution of library paths and you no longer need to provide absolute or relative paths.</li>
</ul>
</div>
    </div>
</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>uretprobe:<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>bash:readline,
</span></span><span style="display:flex;"><span>uretprobe:libreadline:readline
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span>comm <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;bash&#34;</span><span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>(<span style="color:#e6db74">&#34;%H:%M:%S  &#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%-6d %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pid, <span style="color:#a6e22e">str</span>(retval));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Snippet of bashreadline.bt<br><br></span>
<p>The above snippet shows that it uses <em>uretprobe</em> to attach to the return of the <em>readline()</em> function in both <code>/bin/bash</code> and <code>libreadline.so.*</code>. It then prints the time, PID and the input command if the process name is &ldquo;bash&rdquo;.</p>
<p>This is almost exactly the same implementation as <em>BCC</em> bashreadline.py. Let&rsquo;s test this out and see it for ourselves!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo bpftrace bashreadline.bt
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Running <em>bpftrace</em> with bashreadline.bt<br><br></span>
<video width=100% controls>
    <source src="/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/videos/bpftrace-bashreadline.webm" type="video/webm">
    Your browser does not support the video tag.  
</video>
<link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="video"><em>bpftrace</em> Demo - bashreadline.bt<br><br></span>
<h3 id="43-libbpf">4.3 libbpf</h3>
<p>Libbpf supports building eBPF CO-RE(Compile Once, Run Everywhere)-enabled applications, which, in contrast to BCC, do not require Clang/LLVM runtime being deployed to target servers and doesn&rsquo;t rely on kernel-devel headers being available.</p>
<p>It does rely on kernel to be built with BTF type information, though. Some major Linux distributions come with kernel BTF already built in:</p>
<ul>
<li>Fedora 31+</li>
<li>RHEL 8.2+</li>
<li>OpenSUSE Tumbleweed (in the next release, as of 2020-06-04)</li>
<li>Arch Linux (from kernel 5.7.1.arch1-1)</li>
<li>Manjaro (from kernel 5.4 if compiled after 2021-06-18)</li>
<li>Ubuntu 20.10</li>
<li>Debian 11 (amd64/arm64)</li>
</ul>
<p>You can check if your kernel has BTF built-in by looking for <code>/sys/kernel/btf/vmlinux</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ls -la /sys/kernel/btf/vmlinux
</span></span><span style="display:flex;"><span>-r--r--r--. <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">3541561</span> Jun  <span style="color:#ae81ff">2</span> 18:16 /sys/kernel/btf/vmlinux
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Checking if built-in BTF file exists<br><br></span>
<p>If you are running on an older kernel version and absolutely want to run a CO-RE eBPF application on your system, you can override the BTF file path by with the <code>BTF_FILE</code> bash environment variable. You may retrieve the appropriate BTF file from the <a href="https://github.com/aquasecurity/btfhub-archive">BTF Archive</a> by looking up your distro and kernel version.</p>
<p>The easiest way to get started with this framework is to leverage on the examples provided by <a href="https://github.com/libbpf/libbpf-bootstrap">libbpf-bootstrap</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git clone --recurse-submodules https://github.com/libbpf/libbpf-bootstrap
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Getting libbpf-bootstrap Repository<br><br></span>
<p>For simplicity&rsquo;s sake (not because I&rsquo;m lazy 🤭), I am only going to go through the <em>minimal</em> example written in C.
When developing an eBPF application using <em>libbpf</em>, every application requires a <code>.c</code> and a corresponding <code>.bpf.c</code> file.</p>
<p>You can think of it as whatever we write in <code>.c</code> is in user-space while the rest of the logic in <code>.bpf.c</code> resides in kernel space.</p>
<p>Let&rsquo;s start by analyzing the user-space portion of our eBPF application starting from the headers.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;bpf/libbpf.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;minimal.skel.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Headers of minimal.c<br><br></span>
<p>Looking at the listing above, <code>libbpf.h</code> refers to the user-space API for interacting with the BPF syscall while <code>minimal.skel.h</code> is an auto-generated skeleton header from the eBPF program (minimal.bpf.c) when compiling with <code>make</code>. This simplifies the loading/attaching lifecycle.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Open BPF application */</span>
</span></span><span style="display:flex;"><span>skel <span style="color:#f92672">=</span> <span style="color:#a6e22e">minimal_bpf__open</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>skel) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Failed to open BPF skeleton</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Opening BPF Skeleton<br><br></span>
<p>Next the call to <em>minimal_bpf__open()</em> uses the BPF skeleton API, introduced in libbpf to simplify the boilerplate required for loading and managing BPF programs. When you compile your BPF program with bpftool gen skeleton, it creates a .skel.h file that wraps up all maps, programs, and sections into a single C interface.</p>
<p>Note that this call only prepares the skeleton in memory, maps out the BPF sections, but does not yet load or attach anything to the kernel.</p>
<p>Once the skeleton is opened, we can configure its memory-mapped <code>.bss</code> section — a region that is shared between the user-space process and the BPF program in the kernel.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* ensure BPF program only handles write() syscalls from our process */</span>
</span></span><span style="display:flex;"><span>skel<span style="color:#f92672">-&gt;</span>bss<span style="color:#f92672">-&gt;</span>my_pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpid</span>();
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Getting Self PID<br><br></span>
<p>In this case, we’re telling the BPF program:
“Only handle events related to my PID.”</p>
<p>This is a common trick to reduce noise and verifier complexity, especially in minimal test setups. The BPF code (not shown here) is expected to check my_pid and only act on syscall events if they come from this process.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Once that is done, we will proceed to load our eBPF program.
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Load &amp; verify BPF programs */</span>
</span></span><span style="display:flex;"><span>err <span style="color:#f92672">=</span> <span style="color:#a6e22e">minimal_bpf__load</span>(skel);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (err) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Failed to load and verify BPF skeleton</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> cleanup;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Loading and Verifying eBPF Program<br><br></span>
<p>This is where the eBPF bytecode is actually injected into the kernel. libbpf invokes the bpf() syscall to:</p>
<ul>
<li>Load maps</li>
<li>Load programs</li>
<li>Run the verifier</li>
</ul>
<p>If the verifier rejects your eBPF program due to complexity, memory safety, or access issues, this step will fail. All eBPF programs must pass this strict validation step before they are allowed to run in kernel space.</p>
<p>Once loaded, we attach the BPF program to a kernel event.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Attach tracepoint handler */</span>
</span></span><span style="display:flex;"><span>err <span style="color:#f92672">=</span> <span style="color:#a6e22e">minimal_bpf__attach</span>(skel);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (err) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;Failed to attach BPF skeleton</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">goto</span> cleanup;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Attaching eBPF Program<br><br></span>
<p>As to what is going on in this program example, we must take a look at <code>minimal.bpf.c</code>. The source code for it isn&rsquo;t too lengthy and here it is in its full glory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// SPDX-License-Identifier: GPL-2.0 OR BSD-3-Clause
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* Copyright (c) 2020 Facebook */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/bpf.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;bpf/bpf_helpers.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> LICENSE[] <span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;license&#34;</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dual BSD/GPL&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> my_pid <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SEC</span>(<span style="color:#e6db74">&#34;tp/syscalls/sys_enter_write&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_tp</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>ctx)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">bpf_get_current_pid_tgid</span>() <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">!=</span> my_pid)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bpf_printk</span>(<span style="color:#e6db74">&#34;BPF triggered from PID %d.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Full Source Code - minimal.bpf.c<br><br></span>
<p>Remember our <code>my_pid</code> variable that resides in the <code>.bss</code> section? It is in this section because it has been declared as a global variable here. It also declares a BPF program that is attached to the <em>sys_enter_write</em> tracepoint, using the SEC() macro to place the function into the proper ELF section.</p>
<p>This means that every time any process on the system invokes <em>write()</em>, this handler will be called. Tracepoints are stable instrumentation hooks provided by the kernel — great for observability without worrying about kernel version breakage like raw kprobes might cause.</p>
<p>I&rsquo;ve talked quite a lot at this point so let&rsquo;s just compile this and finally get to it.
<link href="/posts/css/alert.css" rel="stylesheet">
<div class="alert tip">
    <div class="alert-content">
        <div class="alert-header">
            <span class="alert-icon"></span>
            <strong class="alert-title">Tip</strong>
        </div>
        <div class="alert-body"><ul>
<li>For static builds, edit the Makefile:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Makefile" data-lang="Makefile"><span style="display:flex;"><span>CFLAGS <span style="color:#f92672">:=</span> -g -Wall -static
</span></span><span style="display:flex;"><span>ALL_LDFLAGS <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>LDFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>EXTRA_LDFLAGS<span style="color:#66d9ef">)</span> -static -lelf -lz -lzstd
</span></span></code></pre></div></li>
</ul>
</div>
    </div>
</div>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Get dependencies</span>
</span></span><span style="display:flex;"><span>$ sudo apt-get install clang llvm build-essential libelf1 libelf-dev zlib1g-dev libzstd-dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compile minimal eBPF application</span>
</span></span><span style="display:flex;"><span>$ cd examples/c
</span></span><span style="display:flex;"><span>$ make minimal
</span></span></code></pre></div><link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="listing">Getting Dependencies and Building Minimal eBPF Application<br><br></span>
<p>Once done, we just run it and open a separate terminal to look at the <code>trace_pipe</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo ./minimal
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Open another terminal</span>
</span></span><span style="display:flex;"><span>$ sudo cat /sys/kernel/debug/tracing/trace_pipe
</span></span></code></pre></div><video width=100% controls>
    <source src="/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-1-introduction/videos/libbpf-bootstrap-minimal.webm" type="video/webm">
    Your browser does not support the video tag.  
</video>
<link href="/posts/css/caption.css" rel="stylesheet">
<span class="caption" data-type="video"><em>libbpf-bootstrap</em> Demo - minimal eBPF Applicatoin<br><br></span>
<h2 id="5-conclusion">5. Conclusion</h2>
<p>There&rsquo;s more to come in part 2 of this series! In the meantime, stay frosty and stay safe!</p>

        
          <hr>
          <div class="post-series"><h3 id="series"> eBPF Malware Techniques Series:</h3> 
    <ol><li><b>eBPF Malware Techniques Part 1 - Introduction</b></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-2-setting-appropriate-hooks/">eBPF Malware Techniques Part 2 - Setting Appropriate Hooks</a></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-3-hiding-bpf-traces/">eBPF Malware Techniques Part 3 - Hiding BPF Traces</a></li><li><a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-4-hiding-processes/">eBPF Malware Techniques Part 4 - Hiding Processes</a></li></ol></div>
        
      </div>
    </article>

    <div class="post-info">
      
    <div class="pagination">
        
        <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
        </div>
        

        <div class="pagination__buttons">

            
            <span class="button previous">
                <a href="https://mathscantor.github.io/posts/gdb-guides/gdb-guide-part7-custom-commands/">
                    <span class="button__icon">←</span>
                    <span class="button__text">GDB Guide Part 7 - Custom Commands</span>
                </a>
            </span>
            

            
            <span class="button next">
                <a href="https://mathscantor.github.io/posts/ebpf-malware-techniques/ebpf-malware-techniques-part-2-setting-appropriate-hooks/">
                    <span class="button__text">eBPF Malware Techniques Part 2 - Setting Appropriate Hooks</span>
                    <span class="button__icon">→</span>
                </a>
            </span>
            

        </div>
    </div>

    </div>
      <div class="sharing-buttons">
        
<a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on facebook">
  <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on twitter">
  <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
      <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;caption=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;canonicalUrl=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on tumblr">
  <div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small">
    <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.563 24c-5.093 0-7.031-3.756-7.031-6.411V9.747H5.116V6.648c3.63-1.313 4.512-4.596 4.71-6.469C9.84.051 9.941 0 9.999 0h3.517v6.114h4.801v3.633h-4.82v7.47c.016 1.001.375 2.371 2.207 2.371h.09c.631-.02 1.486-.205 1.936-.419l1.156 3.425c-.436.636-2.4 1.374-4.156 1.404h-.178l.011.002z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="mailto:?subject=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;body=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_self" rel="noopener" aria-label="" title="Share via email">
  <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://pinterest.com/pin/create/button/?url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f&amp;media=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f;description=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction" target="_blank" rel="noopener" aria-label="" title="Share on pinterest">
  <div class="resp-sharing-button resp-sharing-button--pinterest resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f&amp;title=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;summary=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;source=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on linkedin">
  <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f&amp;resubmit=true&amp;title=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction" target="_blank" rel="noopener" aria-label="" title="Share on reddit">
  <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://www.xing.com/app/user?op=share;url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f;title=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction" target="_blank" rel="noopener" aria-label="" title="Share on xing">
  <div class="resp-sharing-button resp-sharing-button--xing resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M18.188 0c-.517 0-.741.325-.927.66 0 0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211 0 .375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016 0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894 0 21.686 0h-3.498zM3.648 4.74c-.211 0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016 0 .021L1.86 16.051c-.099.188-.093.381 0 .529.085.142.239.234.45.234h3.461c.518 0 .766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="whatsapp://send?text=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction%20https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on whatsapp">
  <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f&amp;t=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction" target="_blank" rel="noopener" aria-label="" title="Share on hacker news">
  <div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
			<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
    </div>
  </div>
</a>


<a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=eBPF%20Malware%20Techniques%20Part%201%20-%20Introduction&amp;url=https%3a%2f%2fmathscantor.github.io%2fposts%2febpf-malware-techniques%2febpf-malware-techniques-part-1-introduction%2f" target="_blank" rel="noopener" aria-label="" title="Share on telegram">
  <div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </div>
  </div>
</a>

      </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
    
        <div class="footer__inner">
            <div class="footer__content">
            
            
        </div>
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.72f1c854c6712730c4f3de06a4221e1c02e35427e559e929eee94792f3fdfa61ccf9ca78e7aff37618f071b6e45c8d06a173fbe595000b2b67d46b44b8289f9f.js" integrity="sha512-cvHIVMZxJzDE894GpCIeHALjVCflWekp7ulHkvP9&#43;mHM&#43;cp456/zdhjwcbbkXI0GoXP75ZUACytn1GtEuCifnw=="></script>



        <script src='/posts/js/caption.js'></script>
        <script data-goatcounter="https://mathscantor.goatcounter.com/count"
        async src="//gc.zgo.at/count.js">console.log("Goat Analytics Loaded");</script>
    </body>
</html>
