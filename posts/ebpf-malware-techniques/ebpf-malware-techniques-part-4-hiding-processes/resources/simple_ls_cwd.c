#define _GNU_SOURCE
#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/syscall.h>
#include <stdint.h>

#define BUF_SIZE 1024

struct linux_dirent64 {
  __ino64_t        d_ino;    // Inode number
  __off64_t        d_off;    // Offset to the next dirent
  unsigned short d_reclen;   // Length of this record
  unsigned char  d_type;     // File type (e.g., DT_DIR, DT_REG)
  char           d_name[];   // Null-terminated filename
};

int main() {
  int fd = open(".", O_RDONLY | O_DIRECTORY);
  if (fd == -1) {
      perror("open");
      return 1;
  }

  char buf[BUF_SIZE];
  ssize_t nread;

  while ((nread = syscall(SYS_getdents64, fd, buf, BUF_SIZE)) > 0) {
      struct linux_dirent64 *d;
      for (int bpos = 0; bpos < nread; bpos += d->d_reclen) {
          d = (struct linux_dirent64 *)(buf + bpos);
          printf("Name: %s, Inode: %llu, Type: %u\n", d->d_name, (unsigned long long)d->d_ino, d->d_type);
      }
  }

  if (nread == -1) {
      perror("getdents64");
  }

  close(fd);
  return 0;
}